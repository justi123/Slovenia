<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Marketplace</title>

<style>
:root {
  --bg: #f4f6f8;
  --text: #000;
  --card: #fff;
  --primary: #3498db;
}

.dark {
  --bg: #1e1e1e;
  --text: #fff;
  --card: #2c2c2c;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
}

header {
  background: var(--primary);
  color: white;
  padding: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.container {
  max-width: 900px;
  margin: 20px auto;
  background: var(--card);
  padding: 20px;
  border-radius: 6px;
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin: 6px 0;
}

button {
  background: var(--primary);
  color: white;
  border: none;
  cursor: pointer;
}

.hidden { display: none; }

.item {
  border: 1px solid #ccc;
  padding: 10px;
  margin-top: 15px;
  border-radius: 4px;
}

.item img {
  max-width: 100%;
  border-radius: 4px;
}

.chat-box {
  border: 1px solid #aaa;
  padding: 10px;
  margin-top: 10px;
  max-height: 200px;
  overflow-y: auto;
}

.chat-msg {
  margin-bottom: 5px;
}

.logout {
  background: #e74c3c;
}
</style>
</head>

<body>

<header>
  <h2>ðŸŽ“ Student Marketplace</h2>
  <button onclick="toggleDark()">ðŸŒ™ Dark Mode</button>
</header>

<div class="container" id="auth">
  <h3>Login</h3>
  <input type="email" id="email" placeholder="Student email">
  <button onclick="login()">Login</button>
</div>

<div class="container hidden" id="market">
  <p id="user"></p>
  <button class="logout" onclick="logout()">Logout</button>

  <hr>

  <h3>Post Item</h3>
  <input id="title" placeholder="Title">
  <select id="category">
    <option>Textbooks</option>
    <option>Furniture</option>
    <option>Electronics</option>
    <option>Bikes / Skis</option>
    <option>Festival Gear</option>
  </select>
  <input id="price" type="number" placeholder="Price â‚¬">
  <input id="image" type="file" accept="image/*">
  <button onclick="addItem()">Post</button>

  <hr>

  <h3>Marketplace</h3>
  <div id="items"></div>
</div>

<div class="container hidden" id="profile"></div>
<div class="container hidden" id="chat"></div>

<script>
let currentUser = localStorage.getItem("user");
let dark = localStorage.getItem("dark") === "true";
if (dark) document.body.classList.add("dark");

function toggleDark() {
  document.body.classList.toggle("dark");
  localStorage.setItem("dark", document.body.classList.contains("dark"));
}

function login() {
  const email = document.getElementById("email").value;
  if (!email) return alert("Enter email");
  localStorage.setItem("user", email);
  currentUser = email;
  showMarket();
}

function logout() {
  localStorage.clear();
  location.reload();
}

function showMarket() {
  auth.classList.add("hidden");
  market.classList.remove("hidden");
  user.innerText = "Logged in as: " + currentUser;
  loadItems();
}

function addItem() {
  const reader = new FileReader();
  const file = image.files[0];

  reader.onload = () => saveItem(reader.result);
  if (file) reader.readAsDataURL(file);
  else saveItem("");
}

function saveItem(img) {
  const items = JSON.parse(localStorage.getItem("items")) || [];
  items.push({
    id: Date.now(),
    title: title.value,
    category: category.value,
    price: price.value,
    image: img,
    seller: currentUser
  });
  localStorage.setItem("items", JSON.stringify(items));
  loadItems();
}

function loadItems() {
  items.innerHTML = "";
  const data = JSON.parse(localStorage.getItem("items")) || [];

  data.forEach(i => {
    items.innerHTML += `
      <div class="item">
        ${i.image ? `<img src="${i.image}">` : ""}
        <b>${i.title}</b><br>
        ${i.category} â€“ â‚¬${i.price}<br>
        <small onclick="openProfile('${i.seller}')" style="cursor:pointer">
          Seller: ${i.seller}
        </small><br>
        ${i.seller !== currentUser ?
          `<button onclick="openChat(${i.id})">Chat with seller</button>` :
          `<button onclick="deleteItem(${i.id})">Delete</button>`
        }
      </div>`;
  });
}

function deleteItem(id) {
  let items = JSON.parse(localStorage.getItem("items"));
  items = items.filter(i => i.id !== id);
  localStorage.setItem("items", JSON.stringify(items));
  loadItems();
}

/* PROFILE */
function openProfile(email) {
  market.classList.add("hidden");
  profile.classList.remove("hidden");

  const items = JSON.parse(localStorage.getItem("items")) || [];
  const list = items.filter(i => i.seller === email);

  profile.innerHTML = `
    <h3>Seller Profile</h3>
    <p>${email}</p>
    <button onclick="back()">Back</button>
    <hr>
    ${list.map(i => `<div>${i.title} â€“ â‚¬${i.price}</div>`).join("")}
  `;
}

/* CHAT */
function openChat(id) {
  market.classList.add("hidden");
  chat.classList.remove("hidden");

  const chats = JSON.parse(localStorage.getItem("chats")) || {};
  const msgs = chats[id] || [];

  chat.innerHTML = `
    <h3>Chat</h3>
    <div class="chat-box">
      ${msgs.map(m => `<div class="chat-msg"><b>${m.user}:</b> ${m.text}</div>`).join("")}
    </div>
    <input id="msg" placeholder="Message">
    <button onclick="sendMsg(${id})">Send</button>
    <button onclick="back()">Back</button>
  `;
}

function sendMsg(id) {
  const chats = JSON.parse(localStorage.getItem("chats")) || {};
  chats[id] = chats[id] || [];
  chats[id].push({ user: currentUser, text: msg.value });
  localStorage.setItem("chats", JSON.stringify(chats));
  openChat(id);
}

function back() {
  profile.classList.add("hidden");
  chat.classList.add("hidden");
  market.classList.remove("hidden");
}

if (currentUser) showMarket();
</script>

</body>
</html>
